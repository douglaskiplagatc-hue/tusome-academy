{% extends "base.html" %}
{% block title %}
    Student Details: {{
    students.full_name }}
{% endblock %}
<link rel="stylesheet" href="static/bootstrap.min.css" />
{% block content %}
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user-graduate"></i> Student Details: {{
                students.full_name }}
            </h1>
            <a href="{{ url_for("admin_bp.manage_students") }}"
               class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Students
            </a>
        </div>
        <div class="row">
            <div class="col-lg-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> Student Profile
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">Admission Number:</dt>
                            <dd class="col-sm-7">
                                {{ students.admission_number }}
                            </dd>
                            <dt class="col-sm-5">Full Name:</dt>
                            <dd class="col-sm-7">
                                {{ students.full_name }}
                            </dd>
                            <dt class="col-sm-5">Date of Birth:</dt>
                            <dd class="col-sm-7">
                                {{ students.date_of_birth.strftime("%B %d, %Y") if
                                student.date_of_birth else 'N/A' }}
                            </dd>
                            <dt class="col-sm-5">Current Class:</dt>
                            <dd class="col-sm-7">
                                {{ student.current_class.name if
                                student.current_class else 'Not Assigned' }}
                            </dd>
                            <dt class="col-sm-5">Parent/Guardian:</dt>
                            <dd class="col-sm-7">
                                {{ student.parent.full_name if student.parent else
                                'N/A' }}
                            </dd>
                        </dl>
                        <div class="d-flex justify-content-end mt-3">
                            <a href="{{ url_for('edit_student', admission_number=student.admission_number) }}"
                               class="btn btn-sm btn-warning me-2">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <form action="{{ url_for('delete_student', admission_number=student.admission_number) }}"
                                  method="POST"
                                  onsubmit="return confirm('Are you sure you want to delete this student?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line"></i> Academic Performance
                            (Latest Grades)
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if student.grades %}
                            <ul class="list-group">
                                {% for grade in
                                    student.grades|sort(attribute='created_at',
                                    reverse=true)|slice(0, 3) %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ grade.subject.name }} ({{ grade.term }}
                                            {{ grade.year }})</strong>
                                            <br />
                                            <small class="text-muted">Recorded: {{ grade.created_at.strftime('%B
                                             %d, %Y') }}</small>
                                        </div>
                                        <span class="badge bg-success rounded-pill p-2">{{ grade.marks }}%</span>
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="text-end mt-3">
                                <a href="#" class="btn btn-sm btn-outline-info">View Full Report</a>
                            </div>
                        {% else %}
                            <div class="alert alert-warning text-center">No grades found for this student.</div>
                        {% endif %}
                    </div>
                </div>
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill-wave"></i> Fee Statement
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if student.fee_statements %}
                            <ul class="list-group">
                                {% for statement in
                                    student.fee_statements|sort(attribute='year',
                                    reverse=true) %}
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>{{ statement.fee_type }} ({{ statement.term
                                            }} {{ statement.year }})</strong>
                                            <span class="badge bg-info">Due: KES {{ "{:,.2f}".format(statement.amount_due) 
                                            }}</span>
                                        </div>
                                        <div class="mt-2">
                                            <span class="text-muted">Paid: KES {{ "{:,.2f}".format(statement.amount_paid) 
                                            }}</span>
                                            {% set balance = statement.amount_due -
                                                                                        statement.amount_paid %}
                                            <span class="float-end {% if balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                                Balance: KES {{ "{:,.2f}".format(balance) }}
                                            </span>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-warning text-center">No fee statements found for this student.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
